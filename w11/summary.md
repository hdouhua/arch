# 11周总结

* [安全架构](#安全架构)
    * [XSS 攻击](#xss-攻击)
      * [XSS 攻击防御手段](#xss-攻击防御手段)
    * [SQL 注入](#sql-注入)
      * [获取数据库表结构信息的手段](#获取数据库表结构信息的手段)
      * [注入攻击防御手段](#注入攻击防御手段)
    * [CSRF攻击](#csrf攻击)
      * [CSRF 攻击防御手段](#csrf-攻击防御手段)
    * [其他需要关注的攻击和漏洞](#其他需要关注的攻击和漏洞)
    * [Web应用防火墙](#web应用防火墙)
    * [网站安全漏洞扫描](#网站安全漏洞扫描)
    * [信息加密技术及密钥安全管理](#信息加密技术及密钥安全管理)
      * [单向散列加密](#单向散列加密)
      * [对称加密](#对称加密)
      * [非对称加密](#非对称加密)
    * [密钥安全管理与加密服务系统架构](#密钥安全管理与加密服务系统架构)
    * [发垃圾邮件](#发垃圾邮件)
    * [贝叶斯分类算法](#贝叶斯分类算法)
    * [布隆过滤黑名单](#布隆过滤黑名单)
    * [电子商务风险控制](#电子商务风险控制)
      * [规则引擎](#规则引擎)
      * [机器学习](#机器学习)
* [高可用架构的度量](#高可用架构的度量)
    * [可用性指标](#可用性指标)
    * [故障分管理](#故障分管理)
      * [故障处理流程及考核](#故障处理流程及考核)
      * [引起故障的原因](#引起故障的原因)
* [高可用系统的架构](#高可用系统的架构)
    * [解耦](#解耦)
    * [隔离](#隔离)
    * [异步](#异步)
    * [备份](#备份)
    * [失效转移](#失效转移)
    * [幂等](#幂等)
    * [事务补偿](#事务补偿)
    * [重试](#重试)
    * [熔断](#熔断)
    * [限流](#限流)
    * [自适应限流](#自适应限流)
    * [降级](#降级)
    * [异地多活](#异地多活)
* [高可用系统的运维](#高可用系统的运维)
    * [发布](#发布)
    * [自动化测试](#自动化测试)
      * [手动测试和自动化测试的总体成本](#手动测试和自动化测试的总体成本)
    * [自动化部署](#自动化部署)
      * [持续部署三步走](#持续部署三步走)
      * [持续部署流程](#持续部署流程)
      * [预发布验证](#预发布验证)
      * [代码版本控制](#代码版本控制)
    * [自动化发布](#自动化发布)
    * [灰度发布](#灰度发布)
    * [网站运行监控](#网站运行监控)
    * [监控数据采集](#监控数据采集)
    * [用户行为日志收集](#用户行为日志收集)
    * [服务器性能监控](#服务器性能监控)
    * [业务运行数据报告](#业务运行数据报告)
    * [监控管理](#监控管理)
    * [监控系统架构](#监控系统架构)
    * [高可用的价值观](#高可用的价值观)
* [参考](#参考)

## 安全架构

下面列举互联网系统90%的攻击方式。

### XSS 攻击



#### XSS 攻击防御手段

消毒！消毒几乎是所有网站最必备的XSS防攻手段。

XSS攻击者一般都是通过在请求中嵌入恶意脚本达到攻击目的，这些脚本是一般用户输入中不使用的，如果进行过滤和消毒处理，即对某些HTML危险字符转义，就可以防止部分攻击。

消毒的过程要注意避免对不必要的内容错误转义，如“3<5”中的“<”，需要进行文本匹配后再转义，如“<img src=”这样的上下文中”<“才转义。

### SQL 注入



#### 获取数据库表结构信息的手段

开源：如果网站采用开源软件搭建，如用Discuz搭建论坛网站，那么网站数据库结构就是公开的，攻击者可以直接获得。

错误回显：如果网站开启错误回显，攻击者故意构造非法参数，服务端异常信息会输出至浏览端，为攻击猜测数据库表结构提供了便利。

盲注：网站关闭错误回显，攻击者根据页面变化情况判断SQL语句的执行情况，据此猜测数据库表结构，此种方式攻击难度较大。

#### 注入攻击防御手段

- 消毒！

  和防XSS攻击一样，请求参数消毒是一种比较简单粗暴由有效的手段。通过正则匹配，过滤请求数据中可能注入的SQL文字

  如，"drop table"、"\b(?:update\b.*?\bset|delete\b\W*?\bfrom)\b"等。

- SQL预编译参数绑定

  使用预编译手段，绑定参数是最好的防SQL注入方法。目前许多数据访问层框架，如myBatis，Hibernate等，都实现SQL预编译和参数绑定，攻击者的恶意SQL会被当作SQL参数，而不是SQL命令被执行。

### CSRF攻击



#### CSRF 攻击防御手段

表单Token

CSRF是一个伪造用户请求的操作，所以需要构造用户请求的所有参数才可以。表单Token就是阻止攻击者获得所有请求参数的可能，在页面表单中增加一个随机参数Token，每次请求的Token都不相同，请求提交后检查Token的值是否正确以确定请求提交者是否合法。

验证码

相对来说，验证码更加简单有效，即请求提交时，需要用户输入验证码，以避免在用户不知情的情况下被攻击者伪造请求。但是输入验证码是一个糟糕的用户体验，所以必要的时候才使用，如支付、交易等关键页面。

Referer check：HTTP请求头 referer 中记录着请求来源，可通过检查请求来源，验证其是否合法。但是该方法有一定的局限性，可以被伪造，且不一定总能得到。

### 其他需要关注的攻击和漏洞

Error Code：也称作错误回显，许多Web服务器默认是打开异常信息输出的，即服务器端未处理的异常堆栈信息会直接输出到客户端浏览器，这种方式虽然对程序调试和错误报告有好处，但同时也给黑客造成可乘之机。通过故意制造非法输入，使系统运行时出错，获得异常信息，从而寻找系统漏洞进行攻击。防御手段也很简单，通过配置Web服务器参数，跳转500页面到专门的错误页面即可，这个功能Web应用常用的MVC框架也可以做到。

HTML注释：为了程序调试方便或其他不恰当的原因，有的时候程序开发人员会在PHP、JSP等服务器页面程序中使用HTML注释语法进行程序注释，这些HTML注释就会显示在客户端浏览器，给黑客造成攻击便利。程序最终发布前需要进行代码review或自动扫描，避免HTML注释漏洞。

文件上传：一般网站都会有文件上传功能，设置头像、分享视频、上传附件等。如果上传的是可执行程序，并通过该程序会的服务器端命令执行能力，那么攻击者几乎可以在服务器上为所欲为，并以此为跳板攻击集群环境的其他机器。最有效的防御手段是设置上传文件白名单，只允许上传可靠的文件类型。此外还可以修改文件名、使用专门的存储手段，保护服务器免受上传文件攻击。

路径遍历：攻击者在请求的URL中使用相对路径，遍历系统未开放的目录和文件。防御方法主要是将Javascript、CSS等资源文件独立服务器、独立域名，其他文件不使用静态URL访问，动态参数不包含文件路径信息。



### Web应用防火墙

开源的Web应用防火墙ModSecurity

ModSecurity是一个开源的Web应用防火墙，探测攻击并保护Web应用程序，既可以嵌入到Web应用服务器中，也可以作为一个独立的应用程序启动。ModSecurity最早只是Apache的一个模块，现在已经有Java、.NET多个版本，并支持Nginx。

ModSecurity采用处理逻辑与规则集合分离的架构模式。处理逻辑负责请求和响应的拦截过滤，规则加载执行等功能。而规则集合则负责对具体的攻击规则定义、模式识别、防御侧露等功能。处理逻辑比较稳定，规则集合需要不断针对漏洞进行升级，这是一种可扩展的架构设计。

### 网站安全漏洞扫描

和电脑安全漏洞扫描一样，网站也需要安全漏洞扫描。

网站安全漏洞扫描工具是根据内置规则，模拟黑客攻击行为，用以发现网站安全漏洞的工具。许多大型网站的安全团队都有自己开发的漏洞扫描工具，不定期的对网站的服务器进行扫描，查漏补缺。

目前市场上也有很多商用的网站安全扫描平台。

 ### 信息加密技术及密钥安全管理

#### 单向散列加密

#### 对称加密

#### 非对称加密

### 密钥安全管理与加密服务系统架构



### 发垃圾邮件

### 贝叶斯分类算法

### 布隆过滤黑名单

### 电子商务风险控制

#### 规则引擎

#### 机器学习



## 高可用架构的度量

### 可用性指标

### 故障分管理

#### 故障处理流程及考核

#### 引起故障的原因

## 高可用系统的架构

### 解耦

高内聚、低耦合的组件设计原则

面向对象基本设计原则

面向对象设计模式

领域驱动设计模式

### 隔离

业务与子系统隔离

微服务与中台架构

生产者消费者隔离

虚拟机与容器隔离

### 异步

### 备份

### 失效转移

### 幂等

### 事务补偿

### 重试

### 熔断

### 限流

### 自适应限流

### 降级

### 异地多活

## 高可用系统的运维

### 发布

### 自动化测试

#### 手动测试和自动化测试的总体成本

### 自动化部署

#### 持续部署三步走

#### 持续部署流程

#### 预发布验证

#### 代码版本控制

### 自动化发布

### 灰度发布

### 网站运行监控

### 监控数据采集

### 用户行为日志收集

### 服务器性能监控

### 业务运行数据报告

### 监控管理

### 监控系统架构

### 高可用的价值观



## 参考



